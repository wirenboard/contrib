From 8236aba58542c5f89f1d41ca09d84579efb05e22 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Sun, 31 May 2020 23:09:59 +0200
Subject: [PATCH] tool_getparam: -i is not OK if -J is used

Reported-by: sn on hackerone
Bug: https://curl.haxx.se/docs/CVE-2020-8177.html
---
 src/tool_cb_hdr.c   | 22 ++++------------------
 src/tool_getparam.c |  5 +++++
 2 files changed, 9 insertions(+), 18 deletions(-)

Index: curl-7.52.1/src/tool_cb_hdr.c
===================================================================
--- curl-7.52.1.orig/src/tool_cb_hdr.c	2020-07-26 17:26:24.693931607 +0200
+++ curl-7.52.1/src/tool_cb_hdr.c	2020-07-26 17:26:24.689931585 +0200
@@ -119,6 +119,10 @@
       len = (ssize_t)cb - (p - str);
       filename = parse_filename(p, len);
       if(filename) {
+	if(outs->stream) {
+           /* indication of problem, get out! */
+           return failure;
+	}
         outs->filename = filename;
         outs->alloc_filename = TRUE;
         outs->is_cd_filename = TRUE;
Index: curl-7.52.1/src/tool_getparam.c
===================================================================
--- curl-7.52.1.orig/src/tool_getparam.c	2020-07-26 17:26:24.693931607 +0200
+++ curl-7.52.1/src/tool_getparam.c	2020-07-26 17:26:24.689931585 +0200
@@ -1596,6 +1596,11 @@
         return err;
       break;
     case 'i':
+      if(config->content_disposition) {
+        warnf(global,
+              "--include and --remote-header-name cannot be combined.\n");
+        return PARAM_BAD_USE;
+      }
       config->include_headers = toggle; /* include the headers as well in the
                                            general output stream */
       break;
